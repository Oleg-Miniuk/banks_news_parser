//release 20180802-1544

!function(s){s(document).ready(function(){var e=document.createElement("iframe");e.charset="utf-8",e.id="ivishnu",e.style.display="none",e.style.border="none",e.style="position:fixed; z-index:0; width:0; height:0; bottom: 0px; right: 0px; visibility:hidden;",e.src="//chat-bankspb.nanosemantics.ru/iframe-transport.html",document.getElementsByTagName("body")[0].appendChild(e)}),s(window).on("message",function(e){var o,r=s("iframe#ivishnu");try{o=JSON.parse(e.originalEvent.data)}catch(e){console.log(e)}if(o){r[0].contentWindow;setTimeout(function(){var e,r=vishnuJQuery(".vishnu-container").data("vishnu").vishnu;switch(o.message){case"toVishnu::nns_livechatStatusRequested":void 0!==o.params&&o.params?resultForTrigger={hasOnlineOperators:!!o.params.hasOwnProperty("hasOnlineOperators")&&o.params.hasOnlineOperators,freeOperatorsCount:o.params.hasOwnProperty("freeOperatorsCount")?o.params.freeOperatorsCount:0}:resultForTrigger={hasOnlineOperators:!1,freeOperatorsCount:0},r.trigger("nns_v3g_livechatStatusRequested",resultForTrigger);break;case"toVishnu::nns_operatorPersonAssigned":if(o.params.operatorAvatar=o.params.operatorAvatar||"//"+window.location.host+window.location.pathname+"images/avatar.png",r.trigger("nns_operatorPersonAssigned",o.params),r.trigger("nns_switchToOperatorSuccess"),localStorage.getItem("history_loaded")||r.History.load(),1==localStorage.getItem("history_sended"))return;r.trigger("v3g_logToOperatorSent"),localStorage.setItem("history_sended",1);break;case"toVishnu::dopOperatorsDate":r.trigger("dop_operatorData",o.params);break;case"toVishnu::nns_operatorTyped":r.trigger("nns_operatorTyped",o.params);break;case"toVishnu::nns_operatorTextSent":if(e===o.params)return;e=o.params,"0"==this.$view.Cookie.getCookie("visible")&&(this.$view.Cookie.setCookie("visible",1,365),this.$view.showVishnu("true")),r.trigger("nns_operatorTextSent",o.params),r.View.showTyping(!1);break;case"toVishnu::nns_switchToVishnu":r.trigger("nns_switchToVishnu",o.params),localStorage.removeItem("history_sended"),r.getLCEModel().setOperatorName("\u0412\u0438\u0440\u0442\u0443\u0430\u043b\u044c\u043d\u044b\u0439 \u043a\u043e\u043d\u0441\u0443\u043b\u044c\u0442\u0430\u043d\u0442"),r.getView().initOperatorRate();break;case"toVishnu::nlab_threadData":var t=o.params,a="vishnu"+r.number+".mibewThreadData";if(!t.hasOwnProperty("thread_id")||!t.hasOwnProperty("token"))throw new Error("\u041d\u0435 \u0445\u0432\u0430\u0442\u0430\u0435\u0442 \u0434\u0430\u043d\u043d\u044b\u0445 \u0434\u043b\u044f \u0441\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u0438\u044f");localStorage.setItem(a,JSON.stringify(t))}},100)}});var e=setInterval(function(){if(s(".vishnu-container").length&&void 0!==s(".vishnu-container").data("vishnu")){clearTimeout(e);var n=s(".vishnu-container").data("vishnu").vishnu;n.on("toMibew::operatorRateSend",function(e,r){var t=s("iframe#ivishnu")[0].contentWindow,a="vishnu"+n.number+".mibewThreadData";try{if(!localStorage.getItem(a))throw new Error("\u041d\u0435\u0442 \u0434\u0430\u043d\u043d\u044b\u0445 thread");if(!r||"0"==r)throw new Error("\u041d\u0435\u0442 \u043e\u0446\u0435\u043d\u043a\u0438");var o=JSON.parse(localStorage.getItem(a));t.postMessage(JSON.stringify(s.extend({},{message:"mibew::rate",threadData:o,rate:r})),"*"),localStorage.removeItem(a)}catch(e){console.log(e)}})}},100)}("undefined"!=typeof vishnuJQuery?vishnuJQuery:jQuery);